{% extends 'base.html' %}

{% block title %}All Alerts - Community Alert System{% endblock %}

{% block extra_css %}
<style>
    .alert-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .alert-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .severity-low { border-left-color: #28a745; }
    .severity-medium { border-left-color: #ffc107; }
    .severity-high { border-left-color: #fd7e14; }
    .severity-critical { border-left-color: #dc3545; }
    
    .filters-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    
    .alert-stats {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="alert-stats">
                <h2><i class="fas fa-list"></i> All Community Alerts</h2>
                <p class="mb-0">Browse security incidents reported across all communities</p>
            </div>
            
            <!-- Filters -->
            <div class="filters-card">
                <h5><i class="fas fa-filter"></i> Filter Alerts</h5>
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="category" class="form-label">Category</label>
                        <select name="category" id="categoryFilter" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="severity" class="form-label">Severity</label>
                        <select name="severity" id="severityFilter" class="form-select">
                            <option value="">All Severities</option>
                            <option value="low" {% if request.GET.severity == 'low' %}selected{% endif %}>üü¢ Low</option>
                            <option value="medium" {% if request.GET.severity == 'medium' %}selected{% endif %}>üü° Medium</option>
                            <option value="high" {% if request.GET.severity == 'high' %}selected{% endif %}>üü† High</option>
                            <option value="critical" {% if request.GET.severity == 'critical' %}selected{% endif %}>üî¥ Critical</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select name="status" id="statusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>üî¥ Active</option>
                            <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>‚úÖ Resolved</option>
                            <option value="under_review" {% if request.GET.status == 'under_review' %}selected{% endif %}>üîç Under Review</option>
                            <option value="false_alarm" {% if request.GET.status == 'false_alarm' %}selected{% endif %}>‚ùå False Alarm</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="community" class="form-label">Community</label>
                        <select name="community" id="communityFilter" class="form-select">
                            <option value="">All Communities</option>
                            {% for community in communities %}
                            <option value="{{ community.id }}" {% if request.GET.community == community.id|stringformat:"s" %}selected{% endif %}>
                                {{ community.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <input type="text" name="search" class="form-control" placeholder="Search alerts..." 
                               value="{{ request.GET.search|default:'' }}">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <a href="{% url 'alert_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <!-- Results -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-exclamation-triangle text-warning"></i> 
                    {% if current_filters.search %}
                        Search Results
                    {% else %}
                        Recent Alerts
                    {% endif %}
                </h4>
                <span class="badge bg-secondary">
                    {% if page_obj %}{{ page_obj.paginator.count }}{% else %}0{% endif %} alert{{ page_obj.paginator.count|pluralize }}
                </span>
            </div>
            
            {% if page_obj %}
            <div class="alerts-container">
                {% for alert in page_obj %}
                <div class="card alert-card severity-{{ alert.severity }} mb-3" data-alert-id="{{ alert.id }}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Alert Header -->
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex flex-wrap gap-1">
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-tag"></i> {{ alert.category.name }}
                                        </span>
                                        <span class="badge 
                                            {% if alert.severity == 'low' %}bg-success
                                            {% elif alert.severity == 'medium' %}bg-warning text-dark
                                            {% elif alert.severity == 'high' %}bg-warning text-dark
                                            {% else %}bg-danger{% endif %}">
                                            {{ alert.get_severity_display }}
                                        </span>
                                        <span class="badge 
                                            {% if alert.status == 'active' %}bg-danger
                                            {% elif alert.status == 'resolved' %}bg-success
                                            {% elif alert.status == 'under_review' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ alert.get_status_display }}
                                        </span>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ alert.created_at|timesince }} ago
                                    </small>
                                </div>
                                
                                <!-- Alert Title -->
                                <h5 class="card-title mb-2">
                                    <a href="{% url 'alert_detail' alert.id %}" class="text-decoration-none">
                                        {{ alert.title }}
                                    </a>
                                </h5>
                                
                                <!-- Alert Description -->
                                <p class="card-text text-muted">
                                    {{ alert.description|truncatewords:25 }}
                                </p>
                                
                                <!-- Location and Community -->
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-users text-primary me-1"></i>
                                        <span class="text-muted">{{ alert.community.name }}</span>
                                        {% if alert.address %}
                                        <span class="text-muted ms-2">
                                            <i class="fas fa-map-marker-alt"></i> {{ alert.address|truncatechars:30 }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <!-- Alert Meta -->
                                <div class="text-end">
                                    <p class="mb-1">
                                        <strong>Reported by:</strong><br>
                                        <i class="fas fa-user"></i> {{ alert.created_by.username }}
                                    </p>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-eye"></i> {{ alert.view_count }} views
                                            <i class="fas fa-thumbs-up ms-2"></i> {{ alert.upvotes }}
                                            <i class="fas fa-thumbs-down ms-1"></i> {{ alert.downvotes }}
                                        </small>
                                    </div>
                                    
                                    <div class="d-flex gap-2 justify-content-end">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="shareAlert('{{ alert.id }}');">
                                            <i class="fas fa-share-alt"></i>
                                        </button>
                                        <a href="{% url 'alert_detail' alert.id %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Alert pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Alerts Found</h4>
                {% if current_filters.search %}
                <p class="text-muted">No alerts match your search criteria. Try adjusting your filters.</p>
                {% else %}
                <p class="text-muted">No alerts have been reported yet. Be the first to report an incident!</p>
                {% endif %}
                
                <div class="mt-3">
                    {% if current_filters.search %}
                    <a href="{% url 'alert_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                    {% endif %}
                    {% if user.is_authenticated %}
                    <a href="{% url 'create_alert' %}" class="btn btn-danger">
                        <i class="fas fa-plus"></i> Report Alert
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Alert data from Django
    const alertsData = [
        {% for alert in page_obj %}
        {
            id: "{{ alert.id }}",
            title: "{{ alert.title|escapejs }}",
            severity: "{{ alert.severity }}",
            status: "{{ alert.status }}",
            category: "{{ alert.category.name|escapejs }}",
            created_at: "{{ alert.created_at|date:'M j, Y g:i A' }}",
            community: "{{ alert.community.name|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Share alert function
    function shareAlert(alertId) {
        if (navigator.share) {
            const alert = alertsData.find(a => a.id === alertId);
            if (alert) {
                navigator.share({
                    title: `Community Alert: ${alert.title}`,
                    text: `${alert.severity.toUpperCase()} alert in ${alert.community}: ${alert.title}`,
                    url: `${window.location.origin}/alerts/${alertId}/`
                }).catch(console.error);
            }
        } else {
            // Fallback: copy link to clipboard
            const url = `${window.location.origin}/alerts/${alertId}/`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Alert link copied to clipboard', 'success');
            }).catch(() => {
                showToast('Unable to copy link', 'error');
            });
        }
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} toast-notification`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        `;
        toast.textContent = message;
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
            style.remove();
        }, 3000);
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Add visual feedback for alert cards
        const alertCards = document.querySelectorAll('.alert-card');
        
        alertCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.borderLeftWidth = '8px';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.borderLeftWidth = '4px';
            });
        });
    });
</script>
{% endblock %}