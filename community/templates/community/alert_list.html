{% extends 'base.html' %}

{% block title %}All Alerts - Community Alert System{% endblock %}

{% block extra_css %}
<style>
    #alertsMap {
        height: 450px;
        width: 100%;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        margin-bottom: 20px;
    }
    .map-toggle {
        position: sticky;
        top: 20px;
        z-index: 1000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .filter-sidebar {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        position: sticky;
        top: 20px;
    }
    .alert-card {
        border-left: 4px solid;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .alert-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .alert-card.highlighted {
        box-shadow: 0 0 0 3px rgba(0,123,255,0.5);
        transform: scale(1.02);
    }
    .severity-low { border-left-color: #28a745; }
    .severity-medium { border-left-color: #ffc107; }
    .severity-high { border-left-color: #fd7e14; }
    .severity-critical { border-left-color: #dc3545; }
    
    .search-stats {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-tags {
        margin-bottom: 1rem;
    }
    
    .filter-tag {
        display: inline-block;
        background-color: #6c757d;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        margin: 0.25rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }
    
    .filter-tag:hover {
        background-color: #5a6268;
        transform: scale(1.05);
    }
    
    .filter-tag .remove {
        margin-left: 0.5rem;
        cursor: pointer;
        font-weight: bold;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .cluster-info {
        background: rgba(255,255,255,0.95);
        border-radius: 6px;
        padding: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-width: 250px;
    }
    
    .severity-legend {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .legend-color {
        width: 20px;
        height: 12px;
        border-radius: 2px;
        margin-right: 8px;
    }
    
    .view-toggle-container {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Map/List View Toggle -->
<div class="view-toggle-container">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-1"><i class="fas fa-exclamation-triangle text-warning"></i> Community Alerts</h4>
            <p class="text-muted mb-0">Monitor security incidents across all communities</p>
        </div>
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewOptions" id="mapView" checked>
            <label class="btn btn-outline-primary" for="mapView">
                <i class="fas fa-map"></i> Map View
            </label>
            
            <input type="radio" class="btn-check" name="viewOptions" id="listView">
            <label class="btn btn-outline-primary" for="listView">
                <i class="fas fa-list"></i> List View
            </label>
        </div>
    </div>
</div>

<!-- Interactive Map Container -->
<div id="mapContainer" class="mb-4">
    <div class="map-toggle">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h5 class="mb-1"><i class="fas fa-map-marked-alt text-primary"></i> Alert Locations</h5>
                <small class="text-muted">Click markers to view alert details • Zoom to explore areas</small>
            </div>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" onclick="centerMapOnUser()">
                    <i class="fas fa-crosshairs"></i> My Location
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="toggleHeatmap()">
                    <i class="fas fa-fire"></i> Density
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="filterByVisible()">
                    <i class="fas fa-eye"></i> Filter Visible
                </button>
            </div>
        </div>
        
        <div style="position: relative;">
            <div id="alertsMap"></div>
            <div class="map-controls">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="showClusters" checked onchange="toggleClustering()">
                    <label class="form-check-label" for="showClusters">
                        <small>Cluster</small>
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showCommunities" onchange="toggleCommunities()">
                    <label class="form-check-label" for="showCommunities">
                        <small>Communities</small>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Severity Legend -->
    <div class="severity-legend">
        <h6 class="mb-3"><i class="fas fa-info-circle text-info"></i> Alert Severity Legend</h6>
        <div class="row">
            <div class="col-6">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #dc3545;"></div>
                    <span>Critical ({{ critical_count|default:0 }})</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #fd7e14;"></div>
                    <span>High ({{ high_count|default:0 }})</span>
                </div>
            </div>
            <div class="col-6">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffc107;"></div>
                    <span>Medium ({{ medium_count|default:0 }})</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #28a745;"></div>
                    <span>Low ({{ low_count|default:0 }})</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="listContainer">
    <!-- Enhanced Filters Sidebar -->
    <div class="col-lg-3">
        <div class="filter-sidebar mb-4">
            <h5><i class="fas fa-filter"></i> Filter & Search</h5>
            <form method="get" id="filterForm">
                <!-- Enhanced Search -->
                <div class="mb-4">
                    <label for="search" class="form-label">Search Alerts</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" id="search" 
                               placeholder="Search title, description, location..." 
                               value="{{ current_filters.search|default:'' }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="form-text">
                        <small><i class="fas fa-lightbulb"></i> Try: "break-in", "suspicious", or "Main Street"</small>
                    </div>
                </div>
                
                <!-- Location-based Filter -->
                <div class="mb-4">
                    <label class="form-label">Near Me</label>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="filterByLocation()">
                            <i class="fas fa-location-arrow"></i> Show Nearby Alerts
                        </button>
                        <div class="form-text text-center">
                            <small id="locationStatus">Click to detect your location</small>
                        </div>
                    </div>
                </div>
                
                <!-- Category Filter -->
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-control" name="category" id="category">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" 
                                {% if current_filters.category == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Severity Filter -->
                <div class="mb-3">
                    <label for="severity" class="form-label">Severity</label>
                    <select class="form-control" name="severity" id="severity">
                        <option value="">All Severities</option>
                        <option value="low" {% if current_filters.severity == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if current_filters.severity == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="high" {% if current_filters.severity == 'high' %}selected{% endif %}>High</option>
                        <option value="critical" {% if current_filters.severity == 'critical' %}selected{% endif %}>Critical</option>
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-control" name="status" id="status">
                        <option value="">All Statuses</option>
                        <option value="active" {% if current_filters.status == 'active' %}selected{% endif %}>Active</option>
                        <option value="resolved" {% if current_filters.status == 'resolved' %}selected{% endif %}>Resolved</option>
                        <option value="under_review" {% if current_filters.status == 'under_review' %}selected{% endif %}>Under Review</option>
                        <option value="false_alarm" {% if current_filters.status == 'false_alarm' %}selected{% endif %}>False Alarm</option>
                    </select>
                </div>
                
                <!-- Community Filter -->
                <div class="mb-3">
                    <label for="community" class="form-label">Community</label>
                    <select class="form-control" name="community" id="community">
                        <option value="">All Communities</option>
                        {% for comm in communities %}
                        <option value="{{ comm.id }}" 
                                {% if current_filters.community == comm.id|stringformat:"s" %}selected{% endif %}>
                            {{ comm.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Date Range Filter -->
                <div class="mb-4">
                    <label class="form-label">Time Period</label>
                    <select class="form-select" name="date_range" id="date_range">
                        <option value="">All time</option>
                        <option value="today" {% if current_filters.date_range == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if current_filters.date_range == 'week' %}selected{% endif %}>This week</option>
                        <option value="month" {% if current_filters.date_range == 'month' %}selected{% endif %}>This month</option>
                    </select>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                    <a href="{% url 'alert_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear All
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="exportResults()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Enhanced Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                {% if user.is_authenticated %}
                <div class="d-grid gap-2">
                    <a href="{% url 'create_alert' %}" class="btn btn-danger">
                        <i class="fas fa-plus"></i> Report New Alert
                    </a>
                    <button type="button" class="btn btn-info" onclick="showMyAlerts()">
                        <i class="fas fa-user"></i> My Alerts
                    </button>
                    <button type="button" class="btn btn-success" onclick="markAreaSafe()">
                        <i class="fas fa-shield-alt"></i> Mark Area Safe
                    </button>
                    <a href="{% url 'user_profile' %}" class="btn btn-outline-primary">
                        <i class="fas fa-cog"></i> Alert Settings
                    </a>
                </div>
                {% else %}
                <div class="text-center">
                    <i class="fas fa-user-lock fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Join to participate in community safety</p>
                    <div class="d-grid gap-2">
                        <a href="{% url 'register' %}" class="btn btn-primary">Sign Up</a>
                        <a href="{% url 'login' %}" class="btn btn-outline-primary">Login</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Alert Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="h4 text-danger">{{ total_active_alerts|default:0 }}</div>
                        <small class="text-muted">Active Alerts</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="h4 text-success">{{ total_resolved_alerts|default:0 }}</div>
                        <small class="text-muted">Resolved</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-info">{{ alerts_today|default:0 }}</div>
                        <small class="text-muted">Today</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-warning">{{ alerts_this_week|default:0 }}</div>
                        <small class="text-muted">This Week</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Main Content -->
    <div class="col-lg-9">
        <!-- Real-time Updates Banner -->
        <div class="alert alert-info alert-dismissible fade show" id="realTimeUpdates" style="display: none;">
            <i class="fas fa-sync-alt fa-spin"></i>
            <strong>Live Updates:</strong> <span id="updateMessage">Checking for new alerts...</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Active Filters -->
        {% if current_filters.search or current_filters.category or current_filters.severity or current_filters.status or current_filters.community %}
        <div class="filter-tags">
            <strong>Active filters:</strong>
            {% if current_filters.search %}
                <span class="filter-tag">
                    Search: "{{ current_filters.search }}"
                    <span class="remove" onclick="removeFilter('search')">&times;</span>
                </span>
            {% endif %}
            {% if current_filters.category %}
                <span class="filter-tag">
                    Category: {{ categories|first.name }}
                    <span class="remove" onclick="removeFilter('category')">&times;</span>
                </span>
            {% endif %}
            {% if current_filters.severity %}
                <span class="filter-tag">
                    Severity: {{ current_filters.severity|title }}
                    <span class="remove" onclick="removeFilter('severity')">&times;</span>
                </span>
            {% endif %}
            {% if current_filters.status %}
                <span class="filter-tag">
                    Status: {{ current_filters.status|title }}
                    <span class="remove" onclick="removeFilter('status')">&times;</span>
                </span>
            {% endif %}
            {% if current_filters.community %}
                <span class="filter-tag">
                    Community: {{ communities|first.name }}
                    <span class="remove" onclick="removeFilter('community')">&times;</span>
                </span>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Enhanced Search Statistics -->
        {% if page_obj %}
        <div class="search-stats">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line fa-2x me-3"></i>
                        <div>
                            <h6 class="mb-1">{{ page_obj.paginator.count }} Alert{{ page_obj.paginator.count|pluralize }}</h6>
                            <small>Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} • Last updated: <span id="lastUpdated">now</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="sortOptions" id="sortRecent" checked>
                        <label class="btn btn-outline-light" for="sortRecent">
                            <i class="fas fa-clock"></i> Recent
                        </label>
                        
                        <input type="radio" class="btn-check" name="sortOptions" id="sortSeverity">
                        <label class="btn btn-outline-light" for="sortSeverity">
                            <i class="fas fa-exclamation-triangle"></i> Severity
                        </label>
                        
                        <input type="radio" class="btn-check" name="sortOptions" id="sortDistance">
                        <label class="btn btn-outline-light" for="sortDistance">
                            <i class="fas fa-map-marker-alt"></i> Distance
                        </label>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Enhanced Alerts List -->
        {% if page_obj %}
        <div class="alerts-container">
            {% for alert in page_obj %}
            <div class="card alert-card severity-{{ alert.severity }} mb-3" 
                 data-alert-id="{{ alert.id }}" 
                 data-lat="{{ alert.latitude }}" 
                 data-lng="{{ alert.longitude }}"
                 onclick="highlightAlert({{ alert.id }})">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Time Indicator -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-secondary"><i class="fas fa-tag"></i> {{ alert.category.name }}</span>
                                    <span class="badge 
                                        {% if alert.severity == 'low' %}bg-success
                                        {% elif alert.severity == 'medium' %}bg-warning text-dark
                                        {% elif alert.severity == 'high' %}bg-warning text-dark
                                        {% else %}bg-danger{% endif %}">
                                        {% if alert.severity == 'low' %}🟢{% elif alert.severity == 'medium' %}🟡{% elif alert.severity == 'high' %}🟠{% else %}🔴{% endif %} {{ alert.get_severity_display }}
                                    </span>
                                    <span class="badge 
                                        {% if alert.status == 'active' %}bg-danger
                                        {% elif alert.status == 'resolved' %}bg-success
                                        {% elif alert.status == 'under_review' %}bg-info
                                        {% else %}bg-secondary{% endif %}">
                                        {% if alert.status == 'active' %}🔴{% elif alert.status == 'resolved' %}✅{% elif alert.status == 'under_review' %}🔍{% else %}⚪{% endif %} {{ alert.get_status_display }}
                                    </span>
                                    {% if alert.is_verified %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-check-circle"></i> Verified
                                    </span>
                                    {% endif %}
                                    {% if alert.incident_datetime|timesince:'now' < '1 hour' %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock"></i> Recent
                                    </span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> {{ alert.incident_datetime|timesince }} ago
                                </small>
                            </div>
                            
                            <h5 class="card-title">
                                <a href="{% url 'alert_detail' alert.id %}" class="text-decoration-none">
                                    {{ alert.title }}
                                </a>
                            </h5>
                            
                            <p class="card-text text-muted">
                                {{ alert.description|truncatewords:25 }}
                            </p>
                            
                            <!-- Enhanced Alert Metadata -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex flex-wrap gap-3">
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> {{ alert.created_by.get_full_name|default:alert.created_by.username }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-home"></i>
                                        <a href="{% url 'community_detail' alert.community.id %}" class="text-decoration-none">
                                            {{ alert.community.name }}
                                        </a>
                                    </small>
                                    {% if alert.distance %}
                                    <small class="text-info">
                                        <i class="fas fa-location-arrow"></i> {{ alert.distance|floatformat:1 }} km away
                                    </small>
                                    {% endif %}
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="showOnMap({{ alert.latitude }}, {{ alert.longitude }}, '{{ alert.title|escapejs }}'); event.stopPropagation();">
                                        <i class="fas fa-map-marker-alt"></i> Map
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="shareAlert({{ alert.id }}); event.stopPropagation();">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Alert Preview Media -->
                            {% if alert.media.exists %}
                            <div class="mb-2">
                                {% with alert.media.first as first_media %}
                                    {% if first_media.media_type == 'image' %}
                                    <img src="{{ first_media.file.url }}" class="img-fluid rounded" 
                                         style="max-height: 80px; width: 100%; object-fit: cover;" 
                                         alt="Alert media">
                                    {% endif %}
                                {% endwith %}
                                <small class="text-info d-block mt-1">
                                    <i class="fas fa-camera"></i> {{ alert.media.count }} media file{{ alert.media.count|pluralize }}
                                </small>
                            </div>
                            {% endif %}
                            
                            <!-- Enhanced Stats -->
                            <div class="alert-stats mb-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="small text-muted">
                                            <i class="fas fa-eye"></i><br>
                                            {{ alert.view_count }}
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="small text-success">
                                            <i class="fas fa-thumbs-up"></i><br>
                                            {{ alert.upvotes }}
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="small text-primary">
                                            <i class="fas fa-comments"></i><br>
                                            {{ alert.comments.count }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-grid gap-1">
                                <a href="{% url 'alert_detail' alert.id %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                {% if user.is_authenticated and alert.status == 'active' %}
                                <button type="button" class="btn btn-outline-success btn-sm" 
                                        onclick="quickUpdate({{ alert.id }}, 'resolved'); event.stopPropagation();">
                                    <i class="fas fa-check"></i> Mark Resolved
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Alerts pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                        <i class="fas fa-angle-left"></i>
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <!-- No Alerts Found -->
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No alerts found</h4>
            <p class="text-muted">
                {% if current_filters.search or current_filters.category or current_filters.severity or current_filters.status or current_filters.community %}
                    Try adjusting your search filters or 
                    <a href="{% url 'alert_list' %}" class="text-decoration-none">clear all filters</a>.
                {% else %}
                    No alerts have been reported yet. Be the first to help keep the community safe!
                {% endif %}
            </p>
            {% if user.is_authenticated %}
            <a href="{% url 'create_alert' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Report First Alert
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let markers = [];
    let markerCluster;
    let heatmap;
    let isMapView = true;
    let userLocation = null;
    let communityBoundaries = [];
    
    // Alert data from Django
    const alertsData = [
        {% for alert in page_obj %}
        {
            id: {{ alert.id }},
            lat: {{ alert.latitude }},
            lng: {{ alert.longitude }},
            title: "{{ alert.title|escapejs }}",
            severity: "{{ alert.severity }}",
            status: "{{ alert.status }}",
            category: "{{ alert.category.name|escapejs }}",
            created_at: "{{ alert.created_at|date:'M j, Y g:i A' }}",
            community: "{{ alert.community.name|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Community boundaries data
    const communities = [
        {% for community in communities %}
        {
            id: {{ community.id }},
            name: "{{ community.name|escapejs }}",
            lat: {{ community.latitude }},
            lng: {{ community.longitude }},
            radius: {{ community.radius_km }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Initialize map
    function initMap() {
        const defaultLocation = { 
            lat: {{ settings.DEFAULT_MAP_CENTER_LAT|default:40.7589 }}, 
            lng: {{ settings.DEFAULT_MAP_CENTER_LNG|default:-73.9851 }} 
        };
        
        map = new google.maps.Map(document.getElementById('alertsMap'), {
            zoom: {{ settings.DEFAULT_MAP_ZOOM|default:13 }},
            center: defaultLocation,
            mapTypeId: 'roadmap',
            styles: [
                {
                    featureType: 'poi',
                    elementType: 'labels',
                    stylers: [{ visibility: 'on' }]
                }
            ]
        });
        
        // Initialize marker clustering
        if (typeof MarkerClusterer !== 'undefined') {
            markerCluster = new MarkerClusterer(map, [], {
                imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
                maxZoom: 15
            });
        }
        
        // Load alerts on map
        loadAlertsOnMap();
        
        // Try to get user's location
        getUserLocation();
    }
    
    // Load alerts as markers on map
    function loadAlertsOnMap() {
        // Clear existing markers
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        
        alertsData.forEach(alert => {
            const marker = new google.maps.Marker({
                position: { lat: alert.lat, lng: alert.lng },
                map: map,
                title: alert.title,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(getMarkerIcon(alert.severity)),
                    scaledSize: new google.maps.Size(30, 35),
                    anchor: new google.maps.Point(15, 35)
                }
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="max-width: 250px; padding: 10px;">
                        <h6 style="color: ${getSeverityColor(alert.severity)}; margin-bottom: 8px;">
                            ${alert.title}
                        </h6>
                        <div style="margin-bottom: 8px;">
                            <span style="background: ${getSeverityColor(alert.severity)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px;">
                                ${alert.severity.toUpperCase()}
                            </span>
                            <span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 4px;">
                                ${alert.category}
                            </span>
                        </div>
                        <p style="margin-bottom: 8px; font-size: 13px;">
                            <strong>Community:</strong> ${alert.community}<br>
                            <strong>Reported:</strong> ${alert.created_at}
                        </p>
                        <div style="text-align: center;">
                            <a href="/alerts/${alert.id}/" style="background: #007bff; color: white; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 12px;">
                                View Details
                            </a>
                        </div>
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(map, marker);
                highlightAlert(alert.id);
            });
            
            markers.push(marker);
        });
        
        // Update marker cluster
        if (markerCluster) {
            markerCluster.clearMarkers();
            markerCluster.addMarkers(markers);
        }
    }
    
    // Get marker icon based on severity
    function getMarkerIcon(severity) {
        const colors = {
            'critical': '#dc3545',
            'high': '#fd7e14',
            'medium': '#ffc107',
            'low': '#28a745'
        };
        
        return `<svg width="30" height="35" viewBox="0 0 30 35" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 0C6.7 0 0 6.7 0 15c0 15 15 20 15 20s15-5 15-20C30 6.7 23.3 0 15 0z" fill="${colors[severity] || '#6c757d'}"/>
            <circle cx="15" cy="15" r="8" fill="white"/>
            <text x="15" y="19" text-anchor="middle" fill="${colors[severity] || '#6c757d'}" font-size="12" font-weight="bold">!</text>
        </svg>`;
    }
    
    // Get severity color
    function getSeverityColor(severity) {
        const colors = {
            'critical': '#dc3545',
            'high': '#fd7e14',
            'medium': '#ffc107',
            'low': '#28a745'
        };
        return colors[severity] || '#6c757d';
    }
    
    // View toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        const mapViewBtn = document.getElementById('mapView');
        const listViewBtn = document.getElementById('listView');
        const mapContainer = document.getElementById('mapContainer');
        const listContainer = document.getElementById('listContainer');
        
        mapViewBtn.addEventListener('change', function() {
            if (this.checked) {
                mapContainer.style.display = 'block';
                listContainer.style.display = 'none';
                isMapView = true;
                // Trigger map resize
                setTimeout(() => {
                    if (map) {
                        google.maps.event.trigger(map, 'resize');
                    }
                }, 100);
            }
        });
        
        listViewBtn.addEventListener('change', function() {
            if (this.checked) {
                mapContainer.style.display = 'none';
                listContainer.style.display = 'block';
                isMapView = false;
            }
        });
        
        // Auto-submit form when filters change
        const filterInputs = document.querySelectorAll('#filterForm select');
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                document.getElementById('filterForm').submit();
            });
        });
        
        // Sort functionality
        const sortButtons = document.querySelectorAll('[name="sortOptions"]');
        sortButtons.forEach(button => {
            button.addEventListener('change', function() {
                console.log('Sort by:', this.id);
                // Implement sorting logic here
            });
        });
        
        // Real-time updates simulation
        setInterval(updateLastUpdatedTime, 30000); // Update every 30 seconds
    });
    
    // Enhanced utility functions
    function highlightAlert(alertId) {
        // Remove previous highlights
        document.querySelectorAll('.alert-card.highlighted').forEach(card => {
            card.classList.remove('highlighted');
        });
        
        // Highlight selected alert
        const alertCard = document.querySelector(`[data-alert-id="${alertId}"]`);
        if (alertCard) {
            alertCard.classList.add('highlighted');
            alertCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function showOnMap(lat, lng, title) {
        // Switch to map view
        document.getElementById('mapView').checked = true;
        document.getElementById('mapView').dispatchEvent(new Event('change'));
        
        // Center map on location
        setTimeout(() => {
            if (map) {
                map.setCenter({ lat: lat, lng: lng });
                map.setZoom(16);
                
                // Find and open info window for this marker
                markers.forEach(marker => {
                    if (marker.getPosition().lat() === lat && marker.getPosition().lng() === lng) {
                        google.maps.event.trigger(marker, 'click');
                    }
                });
            }
        }, 200);
    }
    
    function shareAlert(alertId) {
        const alertUrl = `${window.location.origin}/alerts/${alertId}/`;
        if (navigator.share) {
            navigator.share({
                title: 'Security Alert',
                text: 'Check out this security alert in our community',
                url: alertUrl,
            });
        } else {
            copyToClipboard(alertUrl);
            showToast('Alert link copied to clipboard!');
        }
    }
    
    function centerMapOnUser() {
        if (userLocation) {
            map.setCenter(userLocation);
            map.setZoom(15);
        } else {
            getUserLocation();
        }
    }
    
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Add user location marker
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: 'Your Location',
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                                '<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                                '<circle cx="10" cy="10" r="8" fill="#007bff" stroke="white" stroke-width="2"/>' +
                                '<circle cx="10" cy="10" r="3" fill="white"/>' +
                                '</svg>'
                            ),
                            scaledSize: new google.maps.Size(20, 20)
                        }
                    });
                    
                    document.getElementById('locationStatus').textContent = 'Location detected';
                },
                (error) => {
                    console.log('Location access denied:', error);
                    document.getElementById('locationStatus').textContent = 'Location access denied';
                }
            );
        }
    }
    
    function toggleClustering() {
        const showClusters = document.getElementById('showClusters').checked;
        if (markerCluster) {
            if (showClusters) {
                markerCluster.addMarkers(markers);
            } else {
                markerCluster.clearMarkers();
                markers.forEach(marker => marker.setMap(map));
            }
        }
    }
    
    function toggleCommunities() {
        const showCommunities = document.getElementById('showCommunities').checked;
        
        if (showCommunities) {
            communities.forEach(community => {
                const circle = new google.maps.Circle({
                    strokeColor: '#007bff',
                    strokeOpacity: 0.4,
                    strokeWeight: 2,
                    fillColor: '#007bff',
                    fillOpacity: 0.1,
                    map: map,
                    center: { lat: community.lat, lng: community.lng },
                    radius: community.radius * 1000
                });
                
                communityBoundaries.push(circle);
            });
        } else {
            communityBoundaries.forEach(boundary => boundary.setMap(null));
            communityBoundaries = [];
        }
    }
    
    function removeFilter(filterName) {
        const form = document.getElementById('filterForm');
        const input = form.querySelector(`[name="${filterName}"]`);
        if (input) {
            input.value = '';
            form.submit();
        }
    }
    
    function filterByLocation() {
        if (userLocation) {
            window.location.href = `?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=5`;
        } else {
            getUserLocation();
        }
    }
    
    function quickUpdate(alertId, status) {
        fetch(`/api/alerts/${alertId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Alert updated successfully!');
                location.reload();
            } else {
                showToast('Error updating alert', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error updating alert', 'error');
        });
    }
    
    function updateLastUpdatedTime() {
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if (lastUpdatedEl) {
            const now = new Date();
            lastUpdatedEl.textContent = now.toLocaleTimeString();
        }
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            console.log('Text copied to clipboard');
        }).catch(function(err) {
            console.error('Error copying text: ', err);
        });
    }
</script>

<!-- Load Google Maps API with marker clustering -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key={{ settings.GOOGLE_MAPS_API_KEY|default:'AIzaSyBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' }}&libraries=places,geometry&callback=initMap">
</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

<!-- Map fallback -->
<script>
    setTimeout(function() {
        if (typeof google === 'undefined') {
            document.getElementById('alertsMap').innerHTML = 
                '<div class="alert alert-warning text-center d-flex flex-column justify-content-center" style="height: 400px;">' +
                '<i class="fas fa-map-marked-alt fa-4x mb-3 text-muted"></i>' +
                '<h5>Map Service Unavailable</h5>' +
                '<p class="mb-3">Google Maps could not be loaded. Switch to list view to browse alerts.</p>' +
                '<button class="btn btn-primary" onclick="document.getElementById(\'listView\').click()">Switch to List View</button>' +
                '</div>';
        }
    }, 5000);
</script>
{% endblock %}