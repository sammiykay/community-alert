{% extends 'base.html' %}

{% block title %}Nearby Alerts - Community Alert System{% endblock %}

{% block extra_css %}
<style>
    #nearbyMap {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        margin-bottom: 2rem;
    }
    
    .location-status {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .distance-filter {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    
    .alert-card {
        border-left: 4px solid;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        margin-bottom: 1rem;
    }
    
    .alert-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .severity-low { border-left-color: #28a745; }
    .severity-medium { border-left-color: #ffc107; }
    .severity-high { border-left-color: #fd7e14; }
    .severity-critical { border-left-color: #dc3545; }
    
    .distance-badge {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .no-alerts {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(23,162,184,.3);
        border-radius: 50%;
        border-top-color: #17a2b8;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="location-status">
                <h2><i class="fas fa-map-marker-alt"></i> Nearby Security Alerts</h2>
                <p class="mb-0" id="locationMessage">Finding alerts in your area...</p>
            </div>
        </div>
    </div>
    
    <!-- Distance Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="distance-filter">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5><i class="fas fa-sliders-h text-primary"></i> Search Radius</h5>
                        <p class="text-muted mb-0">Adjust the distance to find alerts near you</p>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-8">
                                <input type="range" class="form-range" id="radiusSlider" min="1" max="50" value="5" 
                                       oninput="updateRadius(this.value)">
                                <div class="d-flex justify-content-between">
                                    <small>1km</small>
                                    <small>50km</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="radiusInput" value="5" min="1" max="50" 
                                           onchange="updateRadiusFromInput(this.value)">
                                    <span class="input-group-text">km</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map -->
    <div class="row mb-4">
        <div class="col-12">
            <div style="position: relative;">
                <div id="nearbyMap"></div>
                <div class="map-controls">
                    <button type="button" class="btn btn-sm btn-outline-primary d-block mb-2" onclick="centerOnUser()">
                        <i class="fas fa-crosshairs"></i> My Location
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary d-block" onclick="refreshAlerts()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alerts List -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-list"></i> Nearby Alerts <span id="alertCount" class="badge bg-primary">0</span></h4>
                <div class="btn-group btn-group-sm">
                    <input type="radio" class="btn-check" name="sortOptions" id="sortDistance" checked>
                    <label class="btn btn-outline-primary" for="sortDistance">
                        <i class="fas fa-location-arrow"></i> Distance
                    </label>
                    <input type="radio" class="btn-check" name="sortOptions" id="sortTime">
                    <label class="btn btn-outline-primary" for="sortTime">
                        <i class="fas fa-clock"></i> Time
                    </label>
                    <input type="radio" class="btn-check" name="sortOptions" id="sortSeverity">
                    <label class="btn btn-outline-primary" for="sortSeverity">
                        <i class="fas fa-exclamation-triangle"></i> Severity
                    </label>
                </div>
            </div>
            
            <div id="alertsList">
                <div class="no-alerts">
                    <div class="loading-spinner mb-3"></div>
                    <p>Loading nearby alerts...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let userLocation = null;
    let userMarker = null;
    let alertMarkers = [];
    let radiusCircle = null;
    let currentRadius = 5; // km
    let nearbyAlerts = [];
    
    // Initialize map
    function initMap() {
        // Default location (will be updated when user location is found)
        const defaultLocation = [{{ settings.DEFAULT_MAP_CENTER_LAT|default:40.7589 }}, {{ settings.DEFAULT_MAP_CENTER_LNG|default:-73.9851 }}];
        
        // Initialize map
        map = L.map('nearbyMap').setView(defaultLocation, 13);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Get user's location
        getUserLocation();
    }
    
    // Get user's current location
    function getUserLocation() {
        if (navigator.geolocation) {
            document.getElementById('locationMessage').innerHTML = 
                '<div class="loading-spinner me-2"></div>Getting your location...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Update map center
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    // Add user location marker
                    const userIcon = L.divIcon({
                        html: '<div style="background: #007bff; border: 3px solid white; border-radius: 50%; width: 24px; height: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><div style="background: white; border-radius: 50%; width: 10px; height: 10px; margin: 4px;"></div></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        className: 'user-location-marker'
                    });
                    
                    userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                        .addTo(map)
                        .bindPopup('Your Location')
                        .openPopup();
                    
                    // Draw radius circle
                    drawRadiusCircle();
                    
                    // Load nearby alerts
                    loadNearbyAlerts();
                    
                    document.getElementById('locationMessage').innerHTML = 
                        `<i class="fas fa-check-circle me-2"></i>Showing alerts within ${currentRadius}km of your location (±${position.coords.accuracy.toFixed(0)}m accuracy)`;
                },
                (error) => {
                    console.log('Location access denied:', error);
                    
                    let errorMessage = '<i class="fas fa-exclamation-triangle me-2"></i>';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Location access denied. Please enable location services and refresh the page.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Your location is currently unavailable. Please enter your address manually.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out. Please try again or enter your address manually.';
                            break;
                        default:
                            errorMessage += 'Unable to get your location. Please enter your address manually.';
                    }
                    
                    document.getElementById('locationMessage').innerHTML = errorMessage;
                    
                    // Show manual location input
                    showManualLocationInput();
                },
                {
                    enableHighAccuracy: true,    // Request high accuracy GPS
                    timeout: 15000,              // Wait up to 15 seconds
                    maximumAge: 0                // Always get fresh location, don't use cache
                }
            );
        } else {
            document.getElementById('locationMessage').innerHTML = 
                '<i class="fas fa-times-circle me-2"></i>Geolocation is not supported by this browser.';
            showManualLocationInput();
        }
    }
    
    // Draw radius circle around user location
    function drawRadiusCircle() {
        if (radiusCircle) {
            map.removeLayer(radiusCircle);
        }
        
        if (userLocation) {
            radiusCircle = L.circle([userLocation.lat, userLocation.lng], {
                radius: currentRadius * 1000, // Convert km to meters
                color: '#17a2b8',
                weight: 2,
                opacity: 0.7,
                fillColor: '#17a2b8',
                fillOpacity: 0.1
            }).addTo(map);
        }
    }
    
    // Load nearby alerts from API
    function loadNearbyAlerts() {
        if (!userLocation) return;
        
        document.getElementById('alertsList').innerHTML = `
            <div class="no-alerts">
                <div class="loading-spinner mb-3"></div>
                <p>Loading nearby alerts...</p>
            </div>
        `;
        
        const url = `/api/alerts/nearby/?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${currentRadius}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                nearbyAlerts = data.results || [];
                displayAlerts(nearbyAlerts);
                addAlertsToMap(nearbyAlerts);
                updateAlertCount(nearbyAlerts.length);
            })
            .catch(error => {
                console.error('Error loading alerts:', error);
                document.getElementById('alertsList').innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                        <h5>Error Loading Alerts</h5>
                        <p>Unable to load nearby alerts. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadNearbyAlerts()">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `;
            });
    }
    
    // Display alerts in the list
    function displayAlerts(alerts) {
        const alertsList = document.getElementById('alertsList');
        
        if (alerts.length === 0) {
            alertsList.innerHTML = `
                <div class="no-alerts">
                    <i class="fas fa-shield-alt fa-3x mb-3 text-success"></i>
                    <h5>No Alerts Nearby</h5>
                    <p>Great news! There are no security alerts in your area within ${currentRadius}km.</p>
                    <p class="text-muted">Try expanding your search radius to see alerts from a wider area.</p>
                </div>
            `;
            return;
        }
        
        const alertsHtml = alerts.map(alert => {
            const severityColor = getSeverityColor(alert.severity);
            const statusIcon = getStatusIcon(alert.status);
            
            return `
                <div class="card alert-card severity-${alert.severity}" onclick="viewAlert('${alert.id}')">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <h6 class="card-title mb-0 me-3">${alert.title}</h6>
                                    <span class="distance-badge">${alert.distance.toFixed(1)} km away</span>
                                </div>
                                <p class="card-text text-muted mb-2">${alert.description.substring(0, 100)}...</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-secondary">${alert.category}</span>
                                    <span class="badge" style="background-color: ${severityColor};">${statusIcon} ${alert.severity.toUpperCase()}</span>
                                    <span class="badge bg-info">${alert.status.replace('_', ' ').toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> ${timeAgo(alert.created_at)}
                                    </small>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-home"></i> ${alert.community}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="event.stopPropagation(); showOnMap(${alert.latitude}, ${alert.longitude})">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); shareAlert('${alert.id}')">
                                        <i class="fas fa-share"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        alertsList.innerHTML = alertsHtml;
    }
    
    // Add alert markers to map
    function addAlertsToMap(alerts) {
        // Clear existing alert markers
        alertMarkers.forEach(marker => map.removeLayer(marker));
        alertMarkers = [];
        
        alerts.forEach(alert => {
            const alertIcon = L.divIcon({
                html: `<div style="background: ${getSeverityColor(alert.severity)}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 12px;">!</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                className: 'alert-marker'
            });
            
            const marker = L.marker([alert.latitude, alert.longitude], { icon: alertIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="max-width: 250px;">
                        <h6 style="color: ${getSeverityColor(alert.severity)};">${alert.title}</h6>
                        <p class="mb-2">${alert.description.substring(0, 100)}...</p>
                        <div class="mb-2">
                            <span class="badge" style="background-color: ${getSeverityColor(alert.severity)};">${alert.severity}</span>
                            <span class="badge bg-secondary ms-1">${alert.category}</span>
                        </div>
                        <div class="text-center">
                            <a href="/alerts/${alert.id}/" class="btn btn-primary btn-sm">View Details</a>
                        </div>
                    </div>
                `);
            
            alertMarkers.push(marker);
        });
    }
    
    // Update radius
    function updateRadius(value) {
        currentRadius = parseInt(value);
        document.getElementById('radiusInput').value = currentRadius;
        drawRadiusCircle();
        loadNearbyAlerts();
        
        if (userLocation) {
            document.getElementById('locationMessage').innerHTML = 
                '<i class="fas fa-check-circle me-2"></i>Showing alerts within ' + currentRadius + 'km of your location';
        }
    }
    
    function updateRadiusFromInput(value) {
        currentRadius = Math.max(1, Math.min(50, parseInt(value) || 5));
        document.getElementById('radiusSlider').value = currentRadius;
        document.getElementById('radiusInput').value = currentRadius;
        drawRadiusCircle();
        loadNearbyAlerts();
        
        if (userLocation) {
            document.getElementById('locationMessage').innerHTML = 
                '<i class="fas fa-check-circle me-2"></i>Showing alerts within ' + currentRadius + 'km of your location';
        }
    }
    
    // Utility functions
    function getSeverityColor(severity) {
        const colors = {
            'critical': '#dc3545',
            'high': '#fd7e14', 
            'medium': '#ffc107',
            'low': '#28a745'
        };
        return colors[severity] || '#6c757d';
    }
    
    function getStatusIcon(status) {
        const icons = {
            'active': '🔴',
            'resolved': '✅',
            'under_review': '🔍',
            'false_alarm': '⚪'
        };
        return icons[status] || '⚪';
    }
    
    function timeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
    }
    
    function updateAlertCount(count) {
        document.getElementById('alertCount').textContent = count;
    }
    
    function viewAlert(alertId) {
        window.location.href = `/alerts/${alertId}/`;
    }
    
    function showOnMap(lat, lng) {
        map.setView([lat, lng], 16);
        
        // Find and open the corresponding marker popup
        alertMarkers.forEach(marker => {
            const markerLatLng = marker.getLatLng();
            if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                marker.openPopup();
            }
        });
    }
    
    function shareAlert(alertId) {
        const alertUrl = `${window.location.origin}/alerts/${alertId}/`;
        if (navigator.share) {
            navigator.share({
                title: 'Security Alert',
                text: 'Check out this security alert',
                url: alertUrl,
            });
        } else {
            navigator.clipboard.writeText(alertUrl).then(() => {
                alert('Alert link copied to clipboard!');
            });
        }
    }
    
    function centerOnUser() {
        if (userLocation) {
            map.setView([userLocation.lat, userLocation.lng], 14);
            if (userMarker) {
                userMarker.openPopup();
            }
        }
    }
    
    function refreshAlerts() {
        loadNearbyAlerts();
    }
    
    function showManualLocationInput() {
        document.getElementById('locationMessage').innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-6">
                    <i class="fas fa-map-marker-alt me-2"></i>Enter your location manually:
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="manualLocation" placeholder="Enter address or city">
                        <button class="btn btn-light" onclick="searchManualLocation()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function searchManualLocation() {
        const address = document.getElementById('manualLocation').value;
        if (!address) return;
        
        // Use Nominatim for geocoding
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const result = data[0];
                    userLocation = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };
                    
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    // Add user location marker
                    const userIcon = L.divIcon({
                        html: '<div style="background: #007bff; border: 3px solid white; border-radius: 50%; width: 24px; height: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><div style="background: white; border-radius: 50%; width: 10px; height: 10px; margin: 4px;"></div></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        className: 'user-location-marker'
                    });
                    
                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                        .addTo(map)
                        .bindPopup('Your Location')
                        .openPopup();
                    
                    drawRadiusCircle();
                    loadNearbyAlerts();
                    
                    document.getElementById('locationMessage').innerHTML = 
                        '<i class="fas fa-check-circle me-2"></i>Showing alerts within ' + currentRadius + 'km of ' + result.display_name;
                } else {
                    alert('Location not found. Please try a different address.');
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                alert('Error searching for location. Please try again.');
            });
    }
    
    // Sort functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map
        setTimeout(initMap, 100);
        
        // Sort event listeners
        document.querySelectorAll('[name="sortOptions"]').forEach(radio => {
            radio.addEventListener('change', function() {
                sortAlerts(this.id.replace('sort', '').toLowerCase());
            });
        });
    });
    
    function sortAlerts(sortBy) {
        let sortedAlerts = [...nearbyAlerts];
        
        switch(sortBy) {
            case 'distance':
                sortedAlerts.sort((a, b) => a.distance - b.distance);
                break;
            case 'time':
                sortedAlerts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
            case 'severity':
                const severityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1 };
                sortedAlerts.sort((a, b) => severityOrder[b.severity] - severityOrder[a.severity]);
                break;
        }
        
        displayAlerts(sortedAlerts);
    }
    
    // Fallback if Leaflet is not available
    setTimeout(function() {
        if (typeof L === 'undefined') {
            document.getElementById('nearbyMap').innerHTML = 
                '<div class="alert alert-warning text-center d-flex flex-column justify-content-center" style="height: 400px;">' +
                '<i class="fas fa-map-marked-alt fa-4x mb-3 text-muted"></i>' +
                '<h5>Map Service Unavailable</h5>' +
                '<p class="mb-3">OpenStreetMap could not be loaded, but you can still view the alerts list below.</p>' +
                '</div>';
        }
    }, 3000);
</script>
{% endblock %}