{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - Community Alert System{% endblock %}

{% block extra_css %}
<style>
    .profile-section {
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        margin-bottom: 2rem;
    }
    .profile-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 2rem;
        border-radius: 8px 8px 0 0;
    }
    .profile-avatar {
        width: 80px;
        height: 80px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-right: 1.5rem;
    }
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #007bff;
    }
    .alert-item {
        border-left: 4px solid;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
        border-radius: 0 8px 8px 0;
        transition: transform 0.2s;
    }
    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .severity-low { border-left-color: #28a745; }
    .severity-medium { border-left-color: #ffc107; }
    .severity-high { border-left-color: #fd7e14; }
    .severity-critical { border-left-color: #dc3545; }
    
    .community-badge {
        background: #17a2b8;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin: 0.25rem;
        display: inline-block;
    }
    
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    
    .section-title {
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Profile Header -->
    <div class="profile-section">
        <div class="profile-header">
            <div class="d-flex align-items-center">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h2 class="mb-1">
                        {% if user.get_full_name %}
                            {{ user.get_full_name }}
                        {% else %}
                            {{ user.username }}
                        {% endif %}
                    </h2>
                    <p class="mb-1">
                        <i class="fas fa-envelope"></i> {{ user.email }}
                        {% if user.phone_number %}
                        <i class="fas fa-phone ms-3"></i> {{ user.phone_number }}
                        {% endif %}
                    </p>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-info me-2">{{ user.get_role_display }}</span>
                        {% if user.email_verified %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Verified
                        </span>
                        {% else %}
                        <span class="badge bg-warning">
                            <i class="fas fa-exclamation-triangle"></i> Email not verified
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Community Membership -->
        <div class="p-3">
            <h5><i class="fas fa-users text-primary"></i> My Communities</h5>
            {% if user.communities.exists %}
                <div class="d-flex flex-wrap">
                    {% for community in user.communities.all %}
                        <span class="community-badge">{{ community.name }}</span>
                    {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">
                    You're a member of {{ user.communities.count }} communit{{ user.communities.count|pluralize:"y,ies" }}.
                    You'll receive alerts from these communities.
                </small>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>No Communities Yet</strong><br>
                    You haven't joined any communities. Update your profile below to join communities and start receiving alerts.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Profile Management -->
        <div class="col-lg-8">
            <!-- Profile Information Form -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-user-edit text-primary"></i> Profile Information
                </h5>
                <form id="profileForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_profile">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name" id="first_name" 
                                   value="{{ user.first_name|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name" id="last_name" 
                                   value="{{ user.last_name|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="phone_number" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" name="phone_number" id="phone_number" 
                               value="{{ user.phone_number|default:'' }}" placeholder="e.g., +1234567890">
                    </div>
                    
                    <div class="mb-3">
                        <label for="communities" class="form-label">Communities</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            {% for community in form.communities.field.queryset %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="communities" 
                                       value="{{ community.id }}" id="community_{{ community.id }}"
                                       {% if community in user.communities.all %}checked{% endif %}>
                                <label class="form-check-label" for="community_{{ community.id }}">
                                    <strong>{{ community.name }}</strong>
                                    {% if community.description %}
                                    <br><small class="text-muted">{{ community.description|truncatechars:100 }}</small>
                                    {% endif %}
                                </label>
                            </div>
                            {% empty %}
                            <p class="text-muted mb-0">No communities available. Contact an administrator to create communities.</p>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">
                            Select the communities you want to join. You'll receive alerts from selected communities.
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                </form>
            </div>
            
            <!-- Notification Settings -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-bell text-primary"></i> Notification Settings
                </h5>
                <form id="notificationForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_notifications">
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="email_notifications" 
                                   id="email_notifications" {% if user.email_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="email_notifications">
                                <strong>Email Notifications</strong><br>
                                <small class="text-muted">Receive alert notifications via email</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="push_notifications" 
                                   id="push_notifications" {% if user.push_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="push_notifications">
                                <strong>Push Notifications</strong><br>
                                <small class="text-muted">Receive push notifications (when available)</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-bell"></i> Update Notifications
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="testNotifications()">
                            <i class="fas fa-test-tube"></i> Test Notifications
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Stats and Quick Actions -->
        <div class="col-lg-4">
            <!-- User Statistics -->
            <div class="row mb-4">
                <div class="col-6">
                    <div class="stats-card">
                        <div class="stats-number">{{ user.created_alerts.count }}</div>
                        <div class="text-muted">Alerts Created</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stats-card">
                        <div class="stats-number">{{ user.communities.count }}</div>
                        <div class="text-muted">Communities</div>
                    </div>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-history text-primary"></i> Recent Alerts
                </h5>
                {% if user_alerts %}
                    {% for alert in user_alerts %}
                    <div class="alert-item severity-{{ alert.severity }}">
                        <h6 class="mb-1">
                            <a href="{% url 'alert_detail' alert.id %}" class="text-decoration-none">
                                {{ alert.title|truncatechars:50 }}
                            </a>
                        </h6>
                        <small class="text-muted">
                            <i class="fas fa-users"></i> {{ alert.community.name }}<br>
                            <i class="fas fa-clock"></i> {{ alert.created_at|timesince }} ago
                        </small>
                    </div>
                    {% endfor %}
                    <div class="text-center mt-3">
                        <a href="{% url 'alert_list' %}?created_by={{ user.id }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list"></i> View All My Alerts
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="fas fa-info-circle"></i><br>
                        You haven't created any alerts yet.
                    </p>
                {% endif %}
            </div>

            <!-- Quick Actions -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-bolt text-primary"></i> Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <a href="{% url 'create_alert' %}" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> Report New Alert
                    </a>
                    <a href="{% url 'my_community_alerts' %}" class="btn btn-info">
                        <i class="fas fa-users"></i> My Community Alerts
                    </a>
                    <button type="button" class="btn btn-success" onclick="testNotifications()">
                        <i class="fas fa-bell"></i> Test Notifications
                    </button>
                    <a href="{% url 'alert_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> Browse All Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Profile form submission
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;
        
        fetch("{% url 'user_profile' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Reload page to show updated information
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(data.error || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while updating your profile', 'error');
        })
        .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // Notification form submission
    document.getElementById('notificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;
        
        fetch("{% url 'user_profile' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while updating notifications', 'error');
        })
        .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // Test notifications
    function testNotifications() {
        const button = document.querySelector('button[onclick="testNotifications()"]');
        const originalText = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;
        
        fetch("{% url 'test_notification' %}", {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Test notification sent successfully!', 'success');
            } else {
                showToast(data.error || 'Failed to send test notification', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while testing notifications', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} toast-notification`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        `;
        toast.innerHTML = `
            <strong>${type === 'error' ? 'Error!' : type === 'success' ? 'Success!' : 'Info:'}</strong><br>
            ${message}
        `;
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
            style.remove();
        }, 4000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Add hover effects to stats cards
        const statsCards = document.querySelectorAll('.stats-card');
        statsCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
        
        // Add smooth scrolling to alert items
        const alertItems = document.querySelectorAll('.alert-item');
        alertItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
            });
            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
            });
        });
    });
</script>
{% endblock %}